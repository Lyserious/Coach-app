<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:Coach_app.ViewModels.Students"
             xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
             x:Class="Coach_app.Views.Students.StudentDetailView"
             Shell.NavBarIsVisible="False"
             Title="{Binding Title}">

    <Grid RowDefinitions="Auto, *" BackgroundColor="#F5F5F5">

        <Frame Grid.Row="0" Padding="15,10" CornerRadius="0" HasShadow="True" BackgroundColor="White" BorderColor="Transparent" ZIndex="1">
            <Grid ColumnDefinitions="Auto, *, Auto">
                <ImageButton Grid.Column="0" Source="dotnet_bot.png" 
                             Command="{Binding CancelCommand}"
                             HeightRequest="30" WidthRequest="30" 
                             HorizontalOptions="Start" VerticalOptions="Center">
                </ImageButton>

                <Label Grid.Column="1" Text="{Binding Title}" 
                       FontSize="18" FontAttributes="Bold" 
                       HorizontalOptions="Center" VerticalOptions="Center" 
                       TextColor="Black"/>

                <Label Grid.Column="2" Text=" " WidthRequest="30"/>
            </Grid>
        </Frame>

        <ScrollView Grid.Row="1">
            <VerticalStackLayout Spacing="20" Padding="20">

                <VerticalStackLayout HorizontalOptions="Center" Spacing="10" Margin="0,10,0,0">
                    <Frame HeightRequest="120" WidthRequest="120" CornerRadius="60" Padding="0" IsClippedToBounds="True" BorderColor="White" HasShadow="False">
                        <Frame.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding PickPhotoCommand}"/>
                        </Frame.GestureRecognizers>
                        <Image Source="{Binding ProfilePhotoPath, Converter={StaticResource StringNullToImageConverter}}" Aspect="AspectFill"/>
                    </Frame>
                    <Label Text="Toucher pour modifier" FontSize="12" TextColor="{StaticResource Primary}" HorizontalOptions="Center"/>
                </VerticalStackLayout>

                <Frame Padding="15" CornerRadius="10" BorderColor="Transparent" BackgroundColor="White">
                    <VerticalStackLayout Spacing="15">
                        <Label Text="IdentitÃ©" FontSize="14" FontAttributes="Bold" TextColor="{StaticResource Primary}"/>

                        <Grid ColumnDefinitions="*,*">
                            <VerticalStackLayout Grid.Column="0" Margin="0,0,5,0">
                                <Label Text="PrÃ©nom" FontSize="12" TextColor="Black"/>
                                <Entry Text="{Binding FirstName}" Placeholder="PrÃ©nom" FontAttributes="Bold"/>
                            </VerticalStackLayout>
                            <VerticalStackLayout Grid.Column="1" Margin="5,0,0,0">
                                <Label Text="Nom" FontSize="12" TextColor="Gray"/>
                                <Entry Text="{Binding LastName}" Placeholder="Nom" FontAttributes="Bold"/>
                            </VerticalStackLayout>
                        </Grid>

                        <VerticalStackLayout>
                            <Label Text="Surnom" FontSize="12" TextColor="Gray"/>
                            <Entry Text="{Binding Nickname}" Placeholder="Surnom (Optionnel)"/>
                        </VerticalStackLayout>

                        <VerticalStackLayout>
                            <Label Text="Date de naissance" FontSize="12" TextColor="Gray"/>
                            <DatePicker Date="{Binding BirthDate}" 
                                        Format="dd/MM/yyyy"
                                        MinimumDate="01/01/1950"
                                        MaximumDate="12/31/2030"
                                        TextColor="Black"
                                        FontAttributes="Bold"/>
                        </VerticalStackLayout>

                        <VerticalStackLayout>
                            <Label Text="Droit Ã  l'image" FontSize="12" TextColor="Gray"/>
                            <Border Stroke="LightGray" StrokeThickness="1" Padding="5" StrokeShape="RoundRectangle 5">
                                <Picker ItemsSource="{Binding ConsentOptions}" 
                                        SelectedItem="{Binding PhotoConsent}"
                                        Title="Choisir l'autorisation"/>
                            </Border>
                        </VerticalStackLayout>

                        <VerticalStackLayout>
                            <Label Text="Niveau" FontSize="12" TextColor="Gray"/>
                            <Picker ItemsSource="{Binding Levels}" SelectedItem="{Binding SelectedLevel}" Title="Choisir un niveau"/>
                        </VerticalStackLayout>
                    </VerticalStackLayout>
                </Frame>

                <Frame Padding="15" CornerRadius="10" BorderColor="Transparent" BackgroundColor="White">
                    <VerticalStackLayout Spacing="15">
                        <Label Text="Contact Personnel" FontSize="14" FontAttributes="Bold" TextColor="{StaticResource Primary}"/>

                        <VerticalStackLayout>
                            <Label Text="Mobile Ã‰lÃ¨ve" FontSize="12" TextColor="Gray"/>
                            <Entry Text="{Binding PhoneNumber}" Keyboard="Telephone" Placeholder="06..." />
                        </VerticalStackLayout>

                        <VerticalStackLayout>
                            <Label Text="Email" FontSize="12" TextColor="Gray"/>
                            <Entry Text="{Binding Email}" Keyboard="Email" Placeholder="exemple@email.com" />
                        </VerticalStackLayout>
                    </VerticalStackLayout>
                </Frame>

                <VerticalStackLayout Spacing="10">
                    <Grid ColumnDefinitions="*, Auto">
                        <Label Text="Contacts d'Urgence / Parents" FontSize="14" FontAttributes="Bold" TextColor="Red" VerticalOptions="Center"/>
                        <Button Grid.Column="1" Text="+ Ajouter" Command="{Binding AddContactCommand}" 
                                HeightRequest="35" FontSize="11" CornerRadius="17" 
                                BackgroundColor="#FFEEEE" TextColor="Red" Padding="15,0"/>
                    </Grid>

                    <StackLayout BindableLayout.ItemsSource="{Binding Contacts}" Spacing="10">
                        <BindableLayout.ItemTemplate>
                            <DataTemplate>
                                <Frame Padding="15" CornerRadius="10" BorderColor="Transparent" BackgroundColor="White">
                                    <Grid RowDefinitions="Auto, Auto, Auto" ColumnDefinitions="*, Auto" RowSpacing="10">

                                        <Button Grid.Row="0" Grid.Column="1" Text="âœ•" 
                                                Command="{Binding Source={RelativeSource AncestorType={x:Type vm:StudentDetailViewModel}}, Path=RemoveContactCommand}"
                                                CommandParameter="{Binding .}"
                                                BackgroundColor="Transparent" TextColor="Gray" 
                                                HeightRequest="30" WidthRequest="30" Padding="0"/>

                                        <VerticalStackLayout Grid.Row="0" Grid.Column="0">
                                            <Label Text="Lien (Qui est-ce ?)" FontSize="11" TextColor="Gray"/>
                                            <Entry Text="{Binding Relation}" Placeholder="Ex: MÃ¨re, PÃ¨re, Voisin..." FontAttributes="Bold" TextColor="Red"/>
                                        </VerticalStackLayout>

                                        <Grid Grid.Row="1" Grid.Column="0" Grid.ColumnSpan="2" ColumnDefinitions="*,*">
                                            <VerticalStackLayout Grid.Column="0" Margin="0,0,5,0">
                                                <Label Text="PrÃ©nom" FontSize="11" TextColor="Gray"/>
                                                <Entry Text="{Binding FirstName}" Placeholder="PrÃ©nom"/>
                                            </VerticalStackLayout>
                                            <VerticalStackLayout Grid.Column="1" Margin="5,0,0,0">
                                                <Label Text="Nom" FontSize="11" TextColor="Gray"/>
                                                <Entry Text="{Binding LastName}" Placeholder="Nom"/>
                                            </VerticalStackLayout>
                                        </Grid>

                                        <VerticalStackLayout Grid.Row="2" Grid.Column="0" Grid.ColumnSpan="2">
                                            <Label Text="TÃ©lÃ©phone" FontSize="11" TextColor="Gray"/>
                                            <Entry Text="{Binding PhoneNumber}" Keyboard="Telephone" Placeholder="NumÃ©ro d'urgence..."/>
                                        </VerticalStackLayout>

                                    </Grid>
                                </Frame>
                            </DataTemplate>
                        </BindableLayout.ItemTemplate>
                    </StackLayout>

                    <Label Text="Aucun contact d'urgence."
                           HorizontalOptions="Center" 
                           TextColor="Gray" 
                           FontSize="12" 
                           Margin="0,10"
                           IsVisible="False">
                        <Label.Triggers>
                            <DataTrigger TargetType="Label" Binding="{Binding Contacts.Count}" Value="0">
                                <Setter Property="IsVisible" Value="True" />
                            </DataTrigger>
                        </Label.Triggers>
                    </Label>
                </VerticalStackLayout>

                <VerticalStackLayout Spacing="10" IsVisible="{Binding IsEditMode}">
                    <Label Text="Suivi &amp; Notes" FontSize="14" FontAttributes="Bold" TextColor="Black"/>

                    <Grid ColumnDefinitions="*, Auto" ColumnSpacing="10">
                        <Entry Grid.Column="0" Text="{Binding NewNoteText}" Placeholder="Ajouter une note..." BackgroundColor="White"/>
                        <Button Grid.Column="1" Text="Envoyer" Command="{Binding AddNoteCommand}" BackgroundColor="Black" TextColor="White" CornerRadius="10"/>
                    </Grid>

                    <StackLayout BindableLayout.ItemsSource="{Binding Notes}" Spacing="5">
                        <BindableLayout.ItemTemplate>
                            <DataTemplate>
                                <Frame Padding="10" BackgroundColor="#FFFBE6" BorderColor="Transparent" CornerRadius="5">
                                    <Grid ColumnDefinitions="*, Auto">
                                        <VerticalStackLayout Grid.Column="0">
                                            <Label Text="{Binding Content}" TextColor="Black" FontSize="14"/>
                                            <Label Text="{Binding Date, StringFormat='{0:dd/MM/yyyy}'}" TextColor="Gray" FontSize="10"/>
                                        </VerticalStackLayout>
                                        <Button Grid.Column="1" Text="ðŸ—‘ï¸" 
                                                Command="{Binding Source={RelativeSource AncestorType={x:Type vm:StudentDetailViewModel}}, Path=DeleteNoteCommand}"
                                                CommandParameter="{Binding .}"
                                                BackgroundColor="Transparent" TextColor="Red" HeightRequest="30"/>
                                    </Grid>
                                </Frame>
                            </DataTemplate>
                        </BindableLayout.ItemTemplate>
                    </StackLayout>
                </VerticalStackLayout>

                <VerticalStackLayout Spacing="10" Margin="0,10,0,30">
                    <Button Text="Enregistrer tout" Command="{Binding SaveCommand}" 
                            BackgroundColor="{StaticResource Primary}" TextColor="White" 
                            CornerRadius="25" HeightRequest="50" FontAttributes="Bold"/>

                    <Button Text="Supprimer l'Ã©lÃ¨ve" Command="{Binding DeleteCommand}" 
                            IsVisible="{Binding IsEditMode}"
                            BackgroundColor="#FFEEEE" TextColor="Red" 
                            CornerRadius="25" HeightRequest="45"/>
                </VerticalStackLayout>

            </VerticalStackLayout>
        </ScrollView>
    </Grid>
</ContentPage>