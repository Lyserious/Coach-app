<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:Coach_app.ViewModels.Groups"
             x:Class="Coach_app.Views.Groups.SessionDetailView"
             x:Name="SessionPage"
             Title="{Binding GroupName}"
             BackgroundColor="#F5F5F5">

    <Grid RowDefinitions="Auto, *">

        <VerticalStackLayout Grid.Row="0" BackgroundColor="White" Shadow="{Shadow Brush=Black, Offset='0,2', Opacity=0.1}">
            <Grid ColumnDefinitions="*, Auto" Padding="20,10">
                <VerticalStackLayout>
                    <Label Text="{Binding DateDisplay}" FontSize="18" FontAttributes="Bold" TextColor="Black"/>
                    <Label Text="{Binding GroupName}" FontSize="12" TextColor="Gray"/>
                </VerticalStackLayout>
                <Button Grid.Column="1" Text="ðŸ’¾" Command="{Binding SavePerformancesCommand}" 
                        IsVisible="{Binding IsPerformanceVisible}" BackgroundColor="Transparent" TextColor="Black"/>
            </Grid>

            <Grid ColumnDefinitions="*,*,*">
                <Button Grid.Column="0" Text="Programme" Command="{Binding SetTabCommand}" CommandParameter="0" 
                        BackgroundColor="Transparent" TextColor="{Binding TabProgramColor}" FontAttributes="Bold"/>
                <Button Grid.Column="1" Text="Performances" Command="{Binding SetTabCommand}" CommandParameter="1" 
                        BackgroundColor="Transparent" TextColor="{Binding TabPerfColor}" FontAttributes="Bold"/>
                <Button Grid.Column="2" Text="Appel" Command="{Binding SetTabCommand}" CommandParameter="2" 
                        BackgroundColor="Transparent" TextColor="{Binding TabAttendanceColor}" FontAttributes="Bold"/>

                <BoxView Grid.Column="{Binding CurrentTab}" VerticalOptions="End" HeightRequest="3" Color="Black"/>
            </Grid>
        </VerticalStackLayout>

        <Grid Grid.Row="1" IsVisible="{Binding IsProgramVisible}">
            <Grid RowDefinitions="Auto, *, Auto">

                <Frame Grid.Row="0" Margin="10,10,10,0" Padding="10" BackgroundColor="White" CornerRadius="10" BorderColor="Transparent">
                    <VerticalStackLayout Spacing="5">
                        <Label Text="Objectifs / Description" FontSize="10" TextColor="Gray" FontAttributes="Bold"/>
                        <Editor Text="{Binding SessionDescription}" 
                                Placeholder="Description de la sÃ©ance..." 
                                AutoSize="TextChanges" 
                                MaximumHeightRequest="100"
                                FontSize="14"/>
                        <Button Text="Enregistrer le texte" 
                                Command="{Binding SaveDescriptionCommand}" 
                                FontSize="10" 
                                HeightRequest="30" 
                                Padding="0"
                                BackgroundColor="#EEE" 
                                TextColor="Black" 
                                HorizontalOptions="End"
                                CornerRadius="5"/>
                    </VerticalStackLayout>
                </Frame>

                <CollectionView Grid.Row="1" ItemsSource="{Binding SessionExercises}" Margin="10">
                    <CollectionView.EmptyView>
                        <Label Text="Aucun exercice" HorizontalOptions="Center" VerticalOptions="Center" TextColor="Gray"/>
                    </CollectionView.EmptyView>
                    <CollectionView.ItemTemplate>
                        <DataTemplate>
                            <Frame Margin="0,5" Padding="15" CornerRadius="10" BackgroundColor="White" BorderColor="Transparent">
                                <Grid ColumnDefinitions="*, Auto">
                                    <VerticalStackLayout Spacing="2">
                                        <Label Text="{Binding Exercise.Name}" FontAttributes="Bold" TextColor="Black"/>
                                        <Label Text="{Binding Exercise.ScoringType}" FontSize="10" TextColor="Black"/>
                                        <HorizontalStackLayout Spacing="5">
                                            <Entry Text="{Binding Sets}" Placeholder="Sets" WidthRequest="40" FontSize="14" HorizontalTextAlignment="Center"/>
                                            <Label Text="x" VerticalOptions="Center"/>
                                            <Entry Text="{Binding Reps}" Placeholder="Reps" WidthRequest="40" FontSize="14" HorizontalTextAlignment="Center"/>
                                            <Entry Text="{Binding Weight}" Placeholder="Kg" WidthRequest="40" FontSize="14" HorizontalTextAlignment="Center"/>
                                        </HorizontalStackLayout>
                                    </VerticalStackLayout>

                                    <VerticalStackLayout Grid.Column="1" Spacing="5">
                                        <Button Text="âœ•" Command="{Binding Source={x:Reference SessionPage}, Path=BindingContext.DeleteExerciseCommand}" CommandParameter="{Binding .}" 
                                                BackgroundColor="#FFEBEE" TextColor="Red" HeightRequest="30" WidthRequest="30" Padding="0" CornerRadius="15"/>
                                        <ImageButton Source="dotnet_bot.png" Command="{Binding Source={x:Reference SessionPage}, Path=BindingContext.UpdateExerciseCommand}" CommandParameter="{Binding .}" HeightRequest="25" WidthRequest="25"/>
                                    </VerticalStackLayout>
                                </Grid>
                            </Frame>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>

                <Grid Grid.Row="2" ColumnDefinitions="*, Auto" Padding="20" ColumnSpacing="10">
                    <Button Grid.Column="0" Text="+ Ajouter Exercice" Command="{Binding AddExerciseCommand}" BackgroundColor="Black" TextColor="White" CornerRadius="10"/>
                    <Button Grid.Column="1" Text="ðŸ“¥" Command="{Binding ImportTemplateCommand}" BackgroundColor="White" TextColor="Black" BorderColor="Black" BorderWidth="1" WidthRequest="50" CornerRadius="10"/>
                </Grid>
            </Grid>
        </Grid>

        <Grid Grid.Row="1" IsVisible="{Binding IsPerformanceVisible}" RowDefinitions="Auto, *">

            <CollectionView Grid.Row="0" ItemsSource="{Binding SessionExercises}" 
                            HeightRequest="60" 
                            SelectionMode="Single"
                            SelectedItem="{Binding SelectedExerciseForPerf, Mode=TwoWay}"
                            HorizontalScrollBarVisibility="Never">
                <CollectionView.ItemsLayout>
                    <LinearItemsLayout Orientation="Horizontal" ItemSpacing="10"/>
                </CollectionView.ItemsLayout>
                <CollectionView.ItemTemplate>
                    <DataTemplate>
                        <Border StrokeShape="RoundRectangle 20" Stroke="Black" StrokeThickness="1" 
                                BackgroundColor="White" Padding="15,5" Margin="5,10">
                            <VisualStateManager.VisualStateGroups>
                                <VisualStateGroup x:Name="CommonStates">
                                    <VisualState x:Name="Normal" />
                                    <VisualState x:Name="Selected">
                                        <VisualState.Setters>
                                            <Setter Property="BackgroundColor" Value="Black" />
                                            <Setter Property="Stroke" Value="Black" />
                                        </VisualState.Setters>
                                    </VisualState>
                                </VisualStateGroup>
                            </VisualStateManager.VisualStateGroups>
                            <Label Text="{Binding Exercise.Name}" VerticalOptions="Center" FontAttributes="Bold" 
                                   TextColor="{Binding Source={RelativeSource AncestorType={x:Type Border}}, Path=BackgroundColor, Converter={StaticResource ColorToInverseConverter}}"/>
                        </Border>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>

            <CollectionView Grid.Row="1" ItemsSource="{Binding StudentPerformances}" Margin="10,0">
                <CollectionView.EmptyView>
                    <Label Text="SÃ©lectionnez un exercice ci-dessus" HorizontalOptions="Center" VerticalOptions="Center" TextColor="Gray"/>
                </CollectionView.EmptyView>
                <CollectionView.ItemTemplate>
                    <DataTemplate>
                        <Frame Margin="0,5" Padding="10" CornerRadius="12" BackgroundColor="White" HasShadow="True">
                            <Grid ColumnDefinitions="Auto, *, Auto">
                                <Image Grid.Column="0" Source="{Binding PhotoPath, Converter={StaticResource StringNullToImageConverter}}" 
                                       Aspect="AspectFill" HeightRequest="45" WidthRequest="45" Margin="0,0,10,0">
                                    <Image.Clip>
                                        <EllipseGeometry Center="22.5,22.5" RadiusX="22.5" RadiusY="22.5"/>
                                    </Image.Clip>
                                </Image>

                                <Label Grid.Column="1" Text="{Binding Name}" VerticalOptions="Center" FontAttributes="Bold" TextColor="#333"/>

                                <Grid Grid.Column="2" WidthRequest="120">

                                    <Grid IsVisible="{Binding IsNumeric}" ColumnDefinitions="Auto, *, Auto">
                                        <Button Grid.Column="0" Text="-" Command="{Binding Source={x:Reference SessionPage}, Path=BindingContext.DecrementScoreCommand}" CommandParameter="{Binding .}" 
                                                HeightRequest="35" WidthRequest="35" Padding="0" BackgroundColor="#EEE" TextColor="Black" CornerRadius="5"/>
                                        <Entry Grid.Column="1" Text="{Binding ValueDisplay}" HorizontalTextAlignment="Center" Keyboard="Numeric" BackgroundColor="Transparent"/>
                                        <Button Grid.Column="2" Text="+" Command="{Binding Source={x:Reference SessionPage}, Path=BindingContext.IncrementScoreCommand}" CommandParameter="{Binding .}" 
                                                HeightRequest="35" WidthRequest="35" Padding="0" BackgroundColor="#EEE" TextColor="Black" CornerRadius="5"/>
                                    </Grid>

                                    <Switch IsToggled="{Binding IsCompleted}" IsVisible="{Binding IsCompletion}" HorizontalOptions="End" OnColor="{StaticResource Primary}"/>

                                    <Entry Text="{Binding ValueDisplay}" Placeholder="Niveau" IsVisible="{Binding IsLevel}" HorizontalOptions="Fill"/>
                                </Grid>
                            </Grid>
                        </Frame>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>
        </Grid>

        <Grid Grid.Row="1" IsVisible="{Binding IsAttendanceVisible}">
            <Grid RowDefinitions="*, Auto">
                <CollectionView Grid.Row="0" ItemsSource="{Binding AttendanceList}" Margin="10">
                    <CollectionView.ItemTemplate>
                        <DataTemplate>
                            <Frame Padding="10" Margin="0,5" CornerRadius="10" BackgroundColor="White">
                                <Grid ColumnDefinitions="Auto, *, Auto">
                                    <Image Grid.Column="0" Source="{Binding PhotoPath, Converter={StaticResource StringNullToImageConverter}}" Aspect="AspectFill" HeightRequest="50" WidthRequest="50" Margin="0,0,10,0"/>
                                    <VerticalStackLayout Grid.Column="1" VerticalOptions="Center">
                                        <Label Text="{Binding DisplayName}" FontAttributes="Bold" TextColor="Black"/>
                                    </VerticalStackLayout>
                                    <Button Grid.Column="2" Text="{Binding Status}" 
                                            Command="{Binding Source={x:Reference SessionPage}, Path=BindingContext.CycleStatusCommand}" 
                                            CommandParameter="{Binding .}" 
                                            HeightRequest="40" FontSize="12" CornerRadius="10" 
                                            BackgroundColor="{Binding Status, Converter={StaticResource StatusToColorConverter}}" TextColor="Black"/>
                                </Grid>
                            </Frame>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>
                <Button Grid.Row="1" Text="Enregistrer Appel" Command="{Binding SaveAttendanceCommand}" BackgroundColor="Black" TextColor="White" Margin="20" CornerRadius="25"/>
            </Grid>
        </Grid>

    </Grid>
</ContentPage>